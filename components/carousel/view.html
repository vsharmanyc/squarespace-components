<!DOCTYPE html>
<!--

    COPY AND PASTE FROM carousel.js, carousel.html, and carousel.css
    https://github.com/vsharmanyc/squarespace-components/tree/master/components/carousel

-->
<html>
    <head>
        <!-- carousel.js -->
        <script>
            // declare state variables
            let viewLimit = 3; // sets the max numnber of tiles to be visible at all times
            let visibleStartIndex = 0; // index of the first visible tile
            let tileListElement; // reference to the tile list html element
            let touchstartX = 0
            let touchendX = 0

            const createElement = (tag, properties = {}) => {
                const element = document.createElement(tag);
                Object.entries(properties).forEach(([key, value]) => element[key] = value );
                return element;
            };

            const tile = (content) => {
                const tile = createElement('div', { classList: 'tile align-center' });

                const tileBody = [
                    content.Image && createElement('img', { src: content.Image, classList: 'display-picture' }),
                    createElement('div', { classList: 'tile-text' })
                ]

                tileBody[1].append(
                    createElement('h2', { innerText: new Date(content.Date).toDateString(), classList: 'date-header' }),
                    createElement('div', { innerText: content.Heading }),
                    createElement('div', { innerText: content.Subheading }),
                    createElement('div', { innerText: content.Description })
                )

                if (content.Registration) {
                    const btn = createElement('a', { innerText: 'Register', href: content.Registration,  target: '_blank', classList: 'btn-link register' });
                    tileBody.push(btn);
                }

                tile.append(...tileBody);
                return tile
            };

            const tileList = (tiles = []) => {
                if (tiles.length) {
                    const spacing = '1.5rem'; // controls the spacing between tiles
                    tiles.forEach(tile => {
                        tile.style.minWidth = `calc(${100 / viewLimit}% - ${(viewLimit + 1) / viewLimit} * ${spacing})`;
                        tile.style.marginLeft = spacing;
                    })
                    tiles[tiles.length - 1].style.marginRight = spacing;
                }
                return tiles;
            };


            const triggerTransition = () => {
                const children = tileListElement.children;
                const offset = children[0].getBoundingClientRect().x - children[visibleStartIndex].getBoundingClientRect().x;
                tileListElement.style.transform = `translate3d(${offset}px, 0px, 0px)`;
                tileListElement.classList.remove('transition-effect');
                tileListElement.classList.add('transition-effect');
            };

            // replicated prev and next functionality using ux from  https://primeng.org/carousel as a reference

            const prev = () => {
                if (visibleStartIndex - viewLimit < 0) return;

                // special case to always ensure viewLimit number tiles in view
                if (visibleStartIndex % viewLimit != 0) {
                    visibleStartIndex -= visibleStartIndex % viewLimit;
                } else {
                    visibleStartIndex -= viewLimit;
                }

                triggerTransition();
            };

            const next = () => {
                const children = tileListElement.children;
                if (visibleStartIndex + viewLimit >= children.length) return;

                visibleStartIndex += viewLimit;
                // special case to always ensure viewLimit number tiles in view
                if (children.length - visibleStartIndex < viewLimit) {
                    visibleStartIndex -= viewLimit - (children.length - visibleStartIndex);
                }

                triggerTransition();
            };

            // we can force the number of tiles in view if we want
            // but less or more tiles may look better different screen sizes 
            const getSuggestedViewLimit = () => {
                if (window.screen.availWidth < 500) {
                    return 1; // lets just suggest only 1 tile in view if screen width < 500px
                }

                const tileListWidth = tileListElement.getBoundingClientRect().width;
                const tileWidth = 350; // lets say a good width for a tile is 350px
                return Math.floor(tileListWidth / tileWidth);
            };

            const resetView = () => {
                const suggestedViewLimit = getSuggestedViewLimit();
                if (viewLimit !== suggestedViewLimit) {
                    viewLimit = suggestedViewLimit;
                    // resize tiles based off new viewLimit
                    tileList(Array.from(tileListElement.children));
                }
                triggerTransition();
            };

            const setupView = (tiles) => {
                tileListElement = document.querySelector('#carousel .tile-list');
                viewLimit = getSuggestedViewLimit();
                tileListElement.append(...tileList(tiles));
                tileListElement.addEventListener('touchstart', onTouchStart);
                tileListElement.addEventListener('touchend', onTouchEnd);
            }

            // reference stack overflow for detecting swipe right and left
            // https://stackoverflow.com/questions/2264072/detect-a-finger-swipe-through-javascript-on-the-iphone-and-android

            function checkDirection() {
                // left swipe
                if (touchendX < touchstartX) next();

                // right swipe
                if (touchendX > touchstartX) prev();
            }

            const onTouchStart = (e) => touchstartX = e.changedTouches[0].screenX;

            const onTouchEnd = (e) => {
                touchendX = e.changedTouches[0].screenX;
                checkDirection();
            }


            const fetchCarouselContent = () => {
                const url = 'https://script.google.com/macros/s/AKfycbwJrO9SW0gmpIyUXhVY4c9s-zo6NWgMENJqfjLWVv4gdccPgzerJZ8MXWXqi0MCtCze/exec';
                return fetch(url)
                .then(response => response.json())
                .catch(() => []);
            }

            document.addEventListener('DOMContentLoaded', () => {
                fetchCarouselContent().then(contentArray => {
                    const tiles = contentArray.map(tileContent => tile(tileContent));
                    setupView(tiles);
                })
            });

            window.addEventListener('resize', resetView);
        </script>

        <!-- carousel.css -->
        <style>
            /* KEEP :root COMMENTED IN PROD, UNCOMMENTED IN LOCAL */
            /* :root {
                --accent-hsl: 19.7080292,55.91836735%,48.03921569%;
                --darkAccent-hsl: 202.14285714,77.77777778%,21.17647059%;
                --lightAccent-hsl: 211.30434783,23.71134021%,80.98039216%;
                --safeLightAccent-hsl: 19.7080292,55.91836735%,48.03921569%;
                --safeDarkAccent-hsl: 19.7080292,55.91836735%,48.03921569%;
                --safeInverseAccent-hsl: 0,0%,100%;
                --safeInverseLightAccent-hsl: 0,0%,100%;
                --safeInverseDarkAccent-hsl: 0,0%,100%;
                --black-hsl: 222.43902439,74.54545455%,10.78431373%;
                --white-hsl: 192,16.12903226%,93.92156863%;
            } */

            .display-picture {
                border-radius: 100%;
                height: 35%;
                width: 35%;
            }

            .tile-text {
                /* font-size: 0.4em; */ 
            }

            .register {
                background-color: hsl(var(--safeDarkAccent-hsl));
                /* margin-top: 1rem; */
            }

            .date-header {
                color: hsl(var(--safeDarkAccent-hsl));
            }

            .btn-link {
                text-decoration: none;
                color: hsl(var(--safeInverseDarkAccent-hsl));
                padding: .9rem 1.2rem;
                border-radius: 0.4rem;
                box-sizing: border-box;
                font-size: 1.1rem;
            }

            .tile {
                height: 100%;
                background-color: hsl(var(--white-hsl));
                overflow: hidden;
                justify-content: space-evenly;
            }

            .align-center {
                display: flex;
                flex-direction: column;
                align-items: center;
            }

            .tile-list-container {
                /* height: 100%; */
                width: 80%;
                overflow: hidden;
            }

            .tile-list {
                display: flex;
                height: 100%;
                width: 100%;
            }

            .transition-effect {
                transition: transform 500ms ease 0s;
            }

            #carousel {
                height: 100%;
                width: 100%;
                display: flex;
                justify-content: center;
            }

            .carousel-btn {
                svg {
                    fill: white;
                    .btn-arrow {
                        stroke: white;
                        fill: none;
                        stroke-width: 2px;
                        stroke-linejoin: round;
                        stroke-linecap: round;
                    }
                    width: 40px;
                }
                border: none;
                cursor: pointer;
                background-color: hsl(var(--safeDarkAccent-hsl));
                opacity: 0.7;
                width: 70px;
                height: 70px;
                border-radius: 100%;
                align-self: center;
            }

            .carousel-btn:hover {
                opacity: 1;
            }
        </style>
    </head>
    <!-- carousel.html -->
    <body>
        <div id="carousel">
            <button class="carousel-btn" onclick="prev()">
                <svg viewBox="0 0 44 18" xmlns="http://www.w3.org/2000/svg">
                    <path class="btn-arrow" d="M9.90649 16.96L2.1221 9.17556L9.9065 1.39116"></path>
                    <path class="btn-arrow" d="M42.8633 9.18125L3.37868 9.18125"></path>

            </button>
            <div class="tile-list-container">
                <div class="tile-list"></div>
            </div>
            <button class="carousel-btn" onclick="next()">
                <svg viewBox="0 0 44 18" xmlns="http://www.w3.org/2000/svg">
                    <path class="btn-arrow" d="M34.1477 1.39111L41.9321 9.17551L34.1477 16.9599"></path>
                    <path class="btn-arrow" d="M1.19088 9.16982H40.6755"></path>
                </svg>
            </button>
        </div>
    </body>
</html>